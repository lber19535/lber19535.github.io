<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="manifest" href="/manifest.json">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha256-xejo6yLi6vGtAjcMIsY8BHdKsLg7QynVlFMzdQgUuy8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"lber19535.github.io","root":"/","images":"/images","scheme":"Mist","darkmode":true,"version":"8.12.3","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="1.起因最近一直在看 C++ 同时想 C++ 看完后结合 ffpemg 和 qt写一个跨平台的播放器，恰好最近轮到我做组内 Presentation，就想着分析下 Android 中的 Media Server 看看 Google 在做播放架构的时候是怎么做的同时可以用到我后续的开发中。">
<meta property="og:type" content="article">
<meta property="og:title" content="Media Player 学习笔记">
<meta property="og:url" content="https://lber19535.github.io/2015/09/16/2015/2015-09-16-Media%20Player%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="LOST HOME">
<meta property="og:description" content="1.起因最近一直在看 C++ 同时想 C++ 看完后结合 ffpemg 和 qt写一个跨平台的播放器，恰好最近轮到我做组内 Presentation，就想着分析下 Android 中的 Media Server 看看 Google 在做播放架构的时候是怎么做的同时可以用到我后续的开发中。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://source.android.com/devices/images/ape_fwk_media.png">
<meta property="og:image" content="http://7xisp0.com1.z0.glb.clouddn.com/media_server_process.png">
<meta property="og:image" content="http://7xisp0.com1.z0.glb.clouddn.com/media_server_service.png">
<meta property="og:image" content="http://7xisp0.com1.z0.glb.clouddn.com/mediaplayer_set_data_flow.png">
<meta property="og:image" content="http://7xisp0.com1.z0.glb.clouddn.com/mediaplayer_class_diagram.png">
<meta property="article:published_time" content="2015-09-16T17:00:00.000Z">
<meta property="article:modified_time" content="2022-08-30T09:51:54.416Z">
<meta property="article:author" content="Bill Lv">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://source.android.com/devices/images/ape_fwk_media.png">


<link rel="canonical" href="https://lber19535.github.io/2015/09/16/2015/2015-09-16-Media%20Player%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://lber19535.github.io/2015/09/16/2015/2015-09-16-Media%20Player%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/","path":"2015/09/16/2015/2015-09-16-Media Player 学习笔记/","title":"Media Player 学习笔记"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Media Player 学习笔记 | LOST HOME</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-S001LDMM2K"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-S001LDMM2K","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">LOST HOME</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">YESTERDAY YOU SAID TOMORROW</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E8%B5%B7%E5%9B%A0"><span class="nav-number">1.</span> <span class="nav-text">1.起因</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Media-Server"><span class="nav-number">2.</span> <span class="nav-text">2.Media Server</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-MediaPlayer-%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">3.</span> <span class="nav-text">3.MediaPlayer 调用流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 构造函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-%E8%AE%BE%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 设置数据源</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-1-%E8%8E%B7%E5%8F%96-MediaPlayerService-%E6%8E%A5%E5%8F%A3"><span class="nav-number">3.2.1.</span> <span class="nav-text">3.2.1 获取 MediaPlayerService 接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-2-%E8%8E%B7%E5%8F%96-MediaPlayer-%E6%8E%A5%E5%8F%A3"><span class="nav-number">3.2.2.</span> <span class="nav-text">3.2.2 获取 MediaPlayer 接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-2-3-%E8%AE%BE%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%BA%90"><span class="nav-number">3.2.3.</span> <span class="nav-text">3.2.3 设置数据源</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-Prepare"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 Prepare</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-start"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 start</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-pause"><span class="nav-number">3.5.</span> <span class="nav-text">3.5 pause</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-stop"><span class="nav-number">3.6.</span> <span class="nav-text">3.6 stop</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-release"><span class="nav-number">3.7.</span> <span class="nav-text">3.7 release</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E6%80%BB%E7%BB%93"><span class="nav-number">4.</span> <span class="nav-text">4.总结</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Bill Lv</p>
  <div class="site-description" itemprop="description">YESTERDAY YOU SAID TOMORROW</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">45</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lber19535.github.io/2015/09/16/2015/2015-09-16-Media%20Player%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Bill Lv">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="LOST HOME">
      <meta itemprop="description" content="YESTERDAY YOU SAID TOMORROW">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Media Player 学习笔记 | LOST HOME">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Media Player 学习笔记
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2015-09-16 17:00:00" itemprop="dateCreated datePublished" datetime="2015-09-16T17:00:00+00:00">2015-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2022-08-30 09:51:54" itemprop="dateModified" datetime="2022-08-30T09:51:54+00:00">2022-08-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span class="firestore-visitors-count"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="1-起因"><a href="#1-起因" class="headerlink" title="1.起因"></a>1.起因</h2><p>最近一直在看 C++ 同时想 C++ 看完后结合 ffpemg 和 qt写一个跨平台的播放器，恰好最近轮到我做组内 Presentation，就想着分析下 Android 中的 Media Server 看看 Google 在做播放架构的时候是怎么做的同时可以用到我后续的开发中。</p>
<span id="more"></span>

<h2 id="2-Media-Server"><a href="#2-Media-Server" class="headerlink" title="2.Media Server"></a>2.Media Server</h2><p>Media Server 整体的架构师 C&#x2F;S 架构，C 和 S 之间的通讯是 IPC，具体来说是 Binder。Media Server 中大量的用到了 Binder。整个架构将播放控制、视频、音频、相机等和多媒体有关的这些包装成不同的服务，通过 IPC 解耦。下图是 Google 关于 Android 中 <a target="_blank" rel="noopener" href="https://source.android.com/devices/media.html">Media 引擎</a>的架构做的关系图。</p>
<p><img src="https://source.android.com/devices/images/ape_fwk_media.png" alt="Media 架构"></p>
<p>在系统 mediaserver 作为一个单独的进程，负责整个系统的音频视频编解码工作：</p>
<p><img src="http://7xisp0.com1.z0.glb.clouddn.com/media_server_process.png" alt="media server 进程"></p>
<p>下面先从 Java 层的调用顺序开始看一下整个调用的流程。</p>
<h2 id="3-MediaPlayer-调用流程"><a href="#3-MediaPlayer-调用流程" class="headerlink" title="3.MediaPlayer 调用流程"></a>3.MediaPlayer 调用流程</h2><p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/media/MediaPlayer.html">MediaPlayer</a> 中涉及到的主要函数都是通过 JNI 来完成的，MediaPlayer.java 对应的是 <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/base/+/android-5.1.1_r18/media/jni/android_media_MediaPlayer.cpp">android_media_MediaPlayer.cpp</a>。其中的对应关系如下，省略了一部分不是特别重要的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> JNINativeMethod gMethods[] = &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;nativeSetDataSource&quot;</span>,</span><br><span class="line">        <span class="string">&quot;(Landroid/os/IBinder;Ljava/lang/String;[Ljava/lang/String;&quot;</span></span><br><span class="line">        <span class="string">&quot;[Ljava/lang/String;)V&quot;</span>,</span><br><span class="line">        (<span class="type">void</span> *)android_media_MediaPlayer_setDataSourceAndHeaders</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;<span class="string">&quot;_setDataSource&quot;</span>,       <span class="string">&quot;(Ljava/io/FileDescriptor;JJ)V&quot;</span>,    (<span class="type">void</span> *)android_media_MediaPlayer_setDataSourceFD&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;_prepare&quot;</span>,            <span class="string">&quot;()V&quot;</span>,                              (<span class="type">void</span> *)android_media_MediaPlayer_prepare&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;prepareAsync&quot;</span>,        <span class="string">&quot;()V&quot;</span>,                              (<span class="type">void</span> *)android_media_MediaPlayer_prepareAsync&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;_start&quot;</span>,              <span class="string">&quot;()V&quot;</span>,                              (<span class="type">void</span> *)android_media_MediaPlayer_start&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;_stop&quot;</span>,               <span class="string">&quot;()V&quot;</span>,                              (<span class="type">void</span> *)android_media_MediaPlayer_stop&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;getVideoWidth&quot;</span>,       <span class="string">&quot;()I&quot;</span>,                              (<span class="type">void</span> *)android_media_MediaPlayer_getVideoWidth&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;getVideoHeight&quot;</span>,      <span class="string">&quot;()I&quot;</span>,                              (<span class="type">void</span> *)android_media_MediaPlayer_getVideoHeight&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;seekTo&quot;</span>,              <span class="string">&quot;(I)V&quot;</span>,                             (<span class="type">void</span> *)android_media_MediaPlayer_seekTo&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;_pause&quot;</span>,              <span class="string">&quot;()V&quot;</span>,                              (<span class="type">void</span> *)android_media_MediaPlayer_pause&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;isPlaying&quot;</span>,           <span class="string">&quot;()Z&quot;</span>,                              (<span class="type">void</span> *)android_media_MediaPlayer_isPlaying&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;getCurrentPosition&quot;</span>,  <span class="string">&quot;()I&quot;</span>,                              (<span class="type">void</span> *)android_media_MediaPlayer_getCurrentPosition&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;getDuration&quot;</span>,         <span class="string">&quot;()I&quot;</span>,                              (<span class="type">void</span> *)android_media_MediaPlayer_getDuration&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;_release&quot;</span>,            <span class="string">&quot;()V&quot;</span>,                              (<span class="type">void</span> *)android_media_MediaPlayer_release&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;_reset&quot;</span>,              <span class="string">&quot;()V&quot;</span>,                              (<span class="type">void</span> *)android_media_MediaPlayer_reset&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;native_init&quot;</span>,         <span class="string">&quot;()V&quot;</span>,                              (<span class="type">void</span> *)android_media_MediaPlayer_native_init&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;native_setup&quot;</span>,        <span class="string">&quot;(Ljava/lang/Object;)V&quot;</span>,            (<span class="type">void</span> *)android_media_MediaPlayer_native_setup&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Java 这边的调用顺序通常是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">MediaPlayer</span> <span class="variable">mp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MediaPlayer</span>();</span><br><span class="line">mp.setDataSource(<span class="string">&quot;/sdcard/test.mp3&quot;</span>);</span><br><span class="line">mp.prepare();</span><br><span class="line">mp.start();</span><br><span class="line">mp.pause();</span><br><span class="line">mp.stop();</span><br><span class="line">mp.release();</span><br></pre></td></tr></table></figure>

<p>下面将按照这个顺序一步一步来分析。</p>
<h3 id="3-1-构造函数"><a href="#3-1-构造函数" class="headerlink" title="3.1 构造函数"></a>3.1 构造函数</h3><p>在 MediaPlayer 的构造函数中调用了 native 的 android_media_MediaPlayer_native_setup 方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">MediaPlayer</span><span class="params">()</span> &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Native setup requires a weak reference to our object.</span></span><br><span class="line"><span class="comment">     * It&#x27;s easier to create it here than in C++.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    native_setup(<span class="keyword">new</span> <span class="title class_">WeakReference</span>&lt;MediaPlayer&gt;(<span class="built_in">this</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>setup 方法中创建了 MediaPlayer，同时也设置了回调函数。其中最后一行的 setMediaPlayer 将 MediaPlayer 的指针保存成一个 Java 对象，之后可以看到 getMediaPlayer 通过同样的方法获取到该对象的指针。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">android_media_MediaPlayer_native_setup</span><span class="params">(JNIEnv *env, jobject thiz, jobject weak_this)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;native_setup&quot;</span>);</span><br><span class="line">    sp&lt;MediaPlayer&gt; mp = <span class="keyword">new</span> <span class="built_in">MediaPlayer</span>();</span><br><span class="line">    <span class="keyword">if</span> (mp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">jniThrowException</span>(env, <span class="string">&quot;java/lang/RuntimeException&quot;</span>, <span class="string">&quot;Out of memory&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// create new listener and give it to MediaPlayer</span></span><br><span class="line">    sp&lt;JNIMediaPlayerListener&gt; listener = <span class="keyword">new</span> <span class="built_in">JNIMediaPlayerListener</span>(env, thiz, weak_this);</span><br><span class="line">    mp-&gt;<span class="built_in">setListener</span>(listener);</span><br><span class="line">    <span class="comment">// Stow our new C++ MediaPlayer in an opaque field in the Java object.</span></span><br><span class="line">    <span class="built_in">setMediaPlayer</span>(env, thiz, mp);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> sp&lt;MediaPlayer&gt; <span class="title">setMediaPlayer</span><span class="params">(JNIEnv* env, jobject thiz, <span class="type">const</span> sp&lt;MediaPlayer&gt;&amp; player)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">Mutex::Autolock <span class="title">l</span><span class="params">(sLock)</span></span>;</span><br><span class="line">    <span class="comment">/* 由于指针的大小和 long 的大小是一样的，所以这里的 get 和 set 可以将</span></span><br><span class="line"><span class="comment">       MediaPlayer 的指针取出或存入*/</span></span><br><span class="line">    sp&lt;MediaPlayer&gt; old = (MediaPlayer*)env-&gt;<span class="built_in">GetLongField</span>(thiz, fields.context);</span><br><span class="line">    <span class="comment">// 判断 mediaplayer 是否为空指针，如果不是，这 sp 引用计数加1</span></span><br><span class="line">    <span class="keyword">if</span> (player.<span class="built_in">get</span>()) &#123;</span><br><span class="line">        player-&gt;<span class="built_in">incStrong</span>((<span class="type">void</span>*)setMediaPlayer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果之前存过 mediaplayer，检查之前存的是否为空，如果不为空，则引用计数减1</span></span><br><span class="line">    <span class="keyword">if</span> (old != <span class="number">0</span>) &#123;</span><br><span class="line">        old-&gt;<span class="built_in">decStrong</span>((<span class="type">void</span>*)setMediaPlayer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将新的 mediaplayer 指针存入 Java 对象中</span></span><br><span class="line">    env-&gt;<span class="built_in">SetLongField</span>(thiz, fields.context, (jlong)player.<span class="built_in">get</span>());</span><br><span class="line">    <span class="keyword">return</span> old;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里解释两点：</p>
<p><strong>1</strong>.由于指针的大小和 long 的大小是一样的，所以可以通过 SetLongField 和 GetLongField 来保存函数指针。<br><strong>2</strong>.由于 shared_ptr 和 weak_ptr 是 C++11 中才加入的，所以源码中实现了 sp 和 wp 作为智能指针来使用，这里可以看到代码中手动控制了引用计数。</p>
<p>现在一个 mediaplayer 对象就创建好了，其他的 jni 中对应的方法几乎都是调用 mediaplayer 来完成的。</p>
<h3 id="3-2-设置数据源"><a href="#3-2-设置数据源" class="headerlink" title="3.2 设置数据源"></a>3.2 设置数据源</h3><p><a target="_blank" rel="noopener" href="https://developer.android.com/reference/android/media/MediaPlayer.html#setDataSource%28java.io.FileDescriptor%29">setDataSource</a> 对应的是 jni 中的这个函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">android_media_MediaPlayer_setDataSourceFD</span><span class="params">(JNIEnv *env, jobject thiz, jobject fileDescriptor, jlong offset, jlong length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;MediaPlayer&gt; mp = <span class="built_in">getMediaPlayer</span>(env, thiz);</span><br><span class="line">    <span class="comment">// mediaplayer 为空</span></span><br><span class="line">    <span class="keyword">if</span> (mp == <span class="literal">NULL</span> ) &#123;</span><br><span class="line">        <span class="built_in">jniThrowException</span>(env, <span class="string">&quot;java/lang/IllegalStateException&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 文件描述符为空</span></span><br><span class="line">    <span class="keyword">if</span> (fileDescriptor == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">jniThrowException</span>(env, <span class="string">&quot;java/lang/IllegalArgumentException&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> fd = <span class="built_in">jniGetFDFromFileDescriptor</span>(env, fileDescriptor);</span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;setDataSourceFD: fd %d&quot;</span>, fd);</span><br><span class="line">    <span class="comment">// 调用 mp-&gt;setDataSource(fd, offset, length) 为 mediaplayer 设置数据源</span></span><br><span class="line">    <span class="built_in">process_media_player_call</span>( env, thiz, mp-&gt;<span class="built_in">setDataSource</span>(fd, offset, length), <span class="string">&quot;java/io/IOException&quot;</span>, <span class="string">&quot;setDataSourceFD failed.&quot;</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到函数开始先做了空指针的判断，之后调用了 mp-&gt;setDataSource(fd, offset, length) 方法来给 mediaplayer 设置数据源，同时 process_media_player_call 函数对 setDataSource 返回值做判断是否设置成功以及失败后抛出异常。</p>
<p>mediaplayer 中的 setDataSource 函数分为三种，分别对应播放文件、网络和流三种情况，现在只看播放文件的情况：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">MediaPlayer::setDataSource</span><span class="params">(<span class="type">int</span> fd, <span class="type">int64_t</span> offset, <span class="type">int64_t</span> length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;setDataSource(%d, %&quot;</span> PRId64 <span class="string">&quot;, %&quot;</span> PRId64 <span class="string">&quot;)&quot;</span>, fd, offset, length);</span><br><span class="line">    <span class="type">status_t</span> err = UNKNOWN_ERROR;</span><br><span class="line">    <span class="comment">// 获取 MediaPlayerService 接口</span></span><br><span class="line">    <span class="function"><span class="type">const</span> sp&lt;IMediaPlayerService&gt;&amp; <span class="title">service</span><span class="params">(getMediaPlayerService())</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (service != <span class="number">0</span>) &#123;</span><br><span class="line">    	<span class="comment">// 获取 MediaPlayer 接口</span></span><br><span class="line">        <span class="function">sp&lt;IMediaPlayer&gt; <span class="title">player</span><span class="params">(service-&gt;create(<span class="keyword">this</span>, mAudioSessionId))</span></span>;</span><br><span class="line">        <span class="comment">// 设置数据源</span></span><br><span class="line">        <span class="keyword">if</span> ((NO_ERROR != <span class="built_in">doSetRetransmitEndpoint</span>(player)) ||</span><br><span class="line">            (NO_ERROR != player-&gt;<span class="built_in">setDataSource</span>(fd, offset, length))) &#123;</span><br><span class="line">           player.<span class="built_in">clear</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        err = <span class="built_in">attachNewPlayer</span>(player);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数分为三个部分，逐个分析。</p>
<h4 id="3-2-1-获取-MediaPlayerService-接口"><a href="#3-2-1-获取-MediaPlayerService-接口" class="headerlink" title="3.2.1 获取 MediaPlayerService 接口"></a>3.2.1 获取 MediaPlayerService 接口</h4><p>这里先是调用了 getMediaPlayerService 方法获取到一个 IMediaPlayerService</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*static*/</span><span class="function"><span class="type">const</span> sp&lt;IMediaPlayerService&gt; &amp;<span class="title">IMediaDeathNotifier::getMediaPlayerService</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;getMediaPlayerService&quot;</span>);</span><br><span class="line">    Mutex::Autolock _l(sServiceLock);</span><br><span class="line">    <span class="keyword">if</span> (sMediaPlayerService == <span class="number">0</span>) &#123;</span><br><span class="line">    	<span class="comment">// 获取 servicemanager</span></span><br><span class="line">        sp&lt;IServiceManager&gt; sm = <span class="built_in">defaultServiceManager</span>();</span><br><span class="line">        sp&lt;IBinder&gt; binder;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">       	    <span class="comment">// 获取对应的 binder</span></span><br><span class="line">            binder = sm-&gt;<span class="built_in">getService</span>(<span class="built_in">String16</span>(<span class="string">&quot;media.player&quot;</span>));</span><br><span class="line">            <span class="keyword">if</span> (binder != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">ALOGW</span>(<span class="string">&quot;Media player service not published, waiting...&quot;</span>);</span><br><span class="line">            <span class="built_in">usleep</span>(<span class="number">500000</span>); <span class="comment">// 0.5 s</span></span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (sDeathNotifier == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            sDeathNotifier = <span class="keyword">new</span> <span class="built_in">DeathNotifier</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        binder-&gt;<span class="built_in">linkToDeath</span>(sDeathNotifier);</span><br><span class="line">        <span class="comment">// asInterface 获取 binder 中的 remote 对象</span></span><br><span class="line">        sMediaPlayerService = <span class="built_in">interface_cast</span>&lt;IMediaPlayerService&gt;(binder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">ALOGE_IF</span>(sMediaPlayerService == <span class="number">0</span>, <span class="string">&quot;no media player service!?&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> sMediaPlayerService;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IServiceManager 是 IInterface 类型，和用 AIDL 生成的接口相同，IInterface 中包含了 binder 和 remote 两个东西。在 ndk 中对应的是 BnInterface 和 BpInterface。在 Java 中，本地 Client 通过 ServiceConnection 中的 onServiceConnected(ComponentName name, IBinder service) 方法获得 Service 中在 onBind 时候返回的 binder，同理，这里通过 ServiceManager 的 getService 获得和 media.player 这个 Service 通信用的 binder。</p>
<p>到这里为止我们只拿到了 media.player Service 的 binder，要想调用接口中的方法还需要通过 asInterface 方法来获得与之对应的 IInterface 接口。这里的 interface_cast<IMediaPlayerService>(binder) 方法就可以获得对应的接口，那么 <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/native/+/jb-mr1-dev/include/binder/IInterface.h">interface_cast</a> 是怎么做到的呢，其实很简单，利用了模板封装了 asInterface 的操作：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> INTERFACE&gt; <span class="keyword">inline</span> sp&lt;INTERFACE&gt; <span class="title">interface_cast</span><span class="params">(<span class="type">const</span> sp&lt;IBinder&gt;&amp; obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> INTERFACE::<span class="built_in">asInterface</span>(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们就拿到了 media.player Service 的接口。</p>
<p>看到这里会有一个疑问，这个 media.player 的 Service 是什么时候启动的呢。我们根据 media.player 这个线索找到了下面的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">MediaPlayerService::instantiate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">defaultServiceManager</span>()-&gt;<span class="built_in">addService</span>(<span class="built_in">String16</span>(<span class="string">&quot;media.player&quot;</span>), <span class="keyword">new</span> <span class="built_in">MediaPlayerService</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc __unused, <span class="type">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function">sp&lt;ProcessState&gt; <span class="title">proc</span><span class="params">(ProcessState::self())</span></span>;</span><br><span class="line">    sp&lt;IServiceManager&gt; sm = <span class="built_in">defaultServiceManager</span>();</span><br><span class="line">    <span class="built_in">ALOGI</span>(<span class="string">&quot;ServiceManager: %p&quot;</span>, sm.<span class="built_in">get</span>());</span><br><span class="line">    AudioFlinger::<span class="built_in">instantiate</span>();</span><br><span class="line">    <span class="comment">// 就是这里啦</span></span><br><span class="line">    MediaPlayerService::<span class="built_in">instantiate</span>();</span><br><span class="line">    <span class="comment">// 照相机</span></span><br><span class="line">    CameraService::<span class="built_in">instantiate</span>();</span><br><span class="line">    <span class="comment">// 音频</span></span><br><span class="line">    AudioPolicyService::<span class="built_in">instantiate</span>();</span><br><span class="line">    <span class="comment">// 语音识别</span></span><br><span class="line">    SoundTriggerHwService::<span class="built_in">instantiate</span>();</span><br><span class="line">    <span class="built_in">registerExtensions</span>();</span><br><span class="line">    ProcessState::<span class="built_in">self</span>()-&gt;<span class="built_in">startThreadPool</span>();</span><br><span class="line">    IPCThreadState::<span class="built_in">self</span>()-&gt;<span class="built_in">joinThreadPool</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中 MediaPlayerService 位于 <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/android-5.1.1_r18/media/libmediaplayerservice/MediaPlayerService.cpp">MediaPlayerService.cpp</a> 中，而 main 函数位于 <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/android-5.1.1_r18/media/mediaserver/main_mediaserver.cpp">main_mediaserver.cpp</a>。还记得在本文最开始的那张图么，其中的 mediaserver 对应的就是这个。它是在开机的时候启动的，被写在了启动脚本中：</p>
<p><img src="http://7xisp0.com1.z0.glb.clouddn.com/media_server_service.png" alt="mediaserver 启动脚本"></p>
<p>这样在系统启动的时候这个进程就开启了，同时里面的 Service 也就启动了。</p>
<h4 id="3-2-2-获取-MediaPlayer-接口"><a href="#3-2-2-获取-MediaPlayer-接口" class="headerlink" title="3.2.2 获取 MediaPlayer 接口"></a>3.2.2 获取 MediaPlayer 接口</h4><p>service-&gt;create(this, mAudioSessionId) 方法通过 IPC 的方式调用 <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/android-5.1.1_r18/media/libmediaplayerservice/MediaPlayerService.cpp">MediaPlayerService</a> 中的 create 方法获得 <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/libmedia/IMediaPlayer.cpp">IMediaPlayer</a>，IMediaPlayer 从名字就可以看出是一个 IInterface，所以 MediaPlayer 也是通过 IPC 来调用的。先看这个方法做了什么：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">sp&lt;IMediaPlayer&gt; <span class="title">MediaPlayerService::create</span><span class="params">(<span class="type">const</span> sp&lt;IMediaPlayerClient&gt;&amp; client, <span class="type">int</span> audioSessionId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">pid_t</span> pid = IPCThreadState::<span class="built_in">self</span>()-&gt;<span class="built_in">getCallingPid</span>();</span><br><span class="line">    <span class="type">int32_t</span> connId = <span class="built_in">android_atomic_inc</span>(&amp;mNextConnId);</span><br><span class="line">    <span class="comment">// MediaPlayerClient</span></span><br><span class="line">    sp&lt;Client&gt; c = <span class="keyword">new</span> <span class="built_in">Client</span>(</span><br><span class="line">            <span class="keyword">this</span>, pid, connId, client, audioSessionId,</span><br><span class="line">            IPCThreadState::<span class="built_in">self</span>()-&gt;<span class="built_in">getCallingUid</span>());</span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;Create new client(%d) from pid %d, uid %d, &quot;</span>, connId, pid,</span><br><span class="line">         IPCThreadState::<span class="built_in">self</span>()-&gt;<span class="built_in">getCallingUid</span>());</span><br><span class="line">    wp&lt;Client&gt; w = c;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">Mutex::Autolock <span class="title">lock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">        <span class="comment">// 管理 Client</span></span><br><span class="line">        mClients.<span class="built_in">add</span>(w);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先调用的时候传的参数是 MediaPlayer 本身，MediaPlayer 除了继承 IMediaDeathNotifier 同时还继承了 BnMediaPlayerClient，而 BnMediaPlayerClient 又继承了 BnInterface<IMediaPlayerClient>，所以这里的参数列表是一个 client 引用。其中 Client 的实现也在 MediaPlayerService.cpp 这个文件中，他的构造函数用来保存这些对象：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MediaPlayerService::Client::<span class="built_in">Client</span>(</span><br><span class="line">        <span class="type">const</span> sp&lt;MediaPlayerService&gt;&amp; service, <span class="type">pid_t</span> pid,</span><br><span class="line">        <span class="type">int32_t</span> connId, <span class="type">const</span> sp&lt;IMediaPlayerClient&gt;&amp; client,</span><br><span class="line">        <span class="type">int</span> audioSessionId, <span class="type">uid_t</span> uid)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;Client(%d) constructor&quot;</span>, connId);</span><br><span class="line">    mPid = pid;</span><br><span class="line">    mConnId = connId;</span><br><span class="line">    mService = service;</span><br><span class="line">    mClient = client;</span><br><span class="line">    mLoop = <span class="literal">false</span>;</span><br><span class="line">    mStatus = NO_INIT;</span><br><span class="line">    mAudioSessionId = audioSessionId;</span><br><span class="line">    mUID = uid;</span><br><span class="line">    mRetransmitEndpointValid = <span class="literal">false</span>;</span><br><span class="line">    mAudioAttributes = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> CALLBACK_ANTAGONIZER</span></span><br><span class="line">    <span class="built_in">ALOGD</span>(<span class="string">&quot;create Antagonizer&quot;</span>);</span><br><span class="line">    mAntagonizer = <span class="keyword">new</span> <span class="built_in">Antagonizer</span>(notify, <span class="keyword">this</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后 create 方法返回一个 MediaPlayer 的接口，这个接口通过 IPC 用来调用 Client 中的函数。</p>
<h4 id="3-2-3-设置数据源"><a href="#3-2-3-设置数据源" class="headerlink" title="3.2.3 设置数据源"></a>3.2.3 设置数据源</h4><p>经过了之前的折腾，我们先拿到了 MediaPlayerService 的接口，通过 MediaPlayerService 的接口又拿到了 MediaPlayer 的接口，接下来就要进行这个函数的最终目的<strong>设置数据源</strong>。</p>
<p>同样是通过 IPC 调用了 MediaPlayer 的 setDataSource，定义如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">status_t</span> MediaPlayerService::Client::<span class="built_in">setDataSource</span>(<span class="type">int</span> fd, <span class="type">int64_t</span> offset, <span class="type">int64_t</span> length)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 前面是一些输出要设置的数据源的信息的 log</span></span><br><span class="line">	...</span><br><span class="line">    <span class="comment">// 获取播放器类型</span></span><br><span class="line">    player_type playerType = MediaPlayerFactory::<span class="built_in">getPlayerType</span>(<span class="keyword">this</span>, fd, offset, length);</span><br><span class="line">    <span class="comment">// 创建播放器</span></span><br><span class="line">    sp&lt;MediaPlayerBase&gt; p = <span class="built_in">setDataSource_pre</span>(playerType);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NO_INIT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// now set data source</span></span><br><span class="line">    <span class="built_in">setDataSource_post</span>(p, p-&gt;<span class="built_in">setDataSource</span>(fd, offset, length));</span><br><span class="line">    <span class="keyword">return</span> mStatus;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>首先是获取播放器类型，播放器类型定义在 <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/android-5.1.1_r18/include/media/MediaPlayerInterface.h">MediaPlayerInterface.h</a> 中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">player_type</span> &#123;</span><br><span class="line">    PV_PLAYER = <span class="number">1</span>,</span><br><span class="line">    SONIVOX_PLAYER = <span class="number">2</span>,</span><br><span class="line">    STAGEFRIGHT_PLAYER = <span class="number">3</span>,</span><br><span class="line">    NU_PLAYER = <span class="number">4</span>,</span><br><span class="line">    <span class="comment">// Test players are available only in the &#x27;test&#x27; and &#x27;eng&#x27; builds.</span></span><br><span class="line">    <span class="comment">// The shared library with the test player is passed passed as an</span></span><br><span class="line">    <span class="comment">// argument to the &#x27;test:&#x27; url in the setDataSource call.</span></span><br><span class="line">    TEST_PLAYER = <span class="number">5</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面说下这几种类型是做什么的，其中的每一个都对应一个工厂来创建对应的 Player，由于 PV_PLAYER 已经被抛弃了，所以在 5.1 的源码里并没有出现它</p>
<p>1.<strong>PV_PLAYER</strong>    这个类型是 Android 最初采用的 OpenCore，由于太臃肿已经被抛弃<br>2.<strong>SONIVOX_PLAYER</strong>   用来处理 midi 相关<br>3.<strong>NU_PLAYER</strong>    全能型，在 5.x 上处于可选<br>4.<strong>STAGEFRIGHT_PLAYER</strong>    5.x 之前的主力即 awesome player ，可以胜任除 midi 外全部的工作<br>5.<strong>TEST_PLAYER</strong>    测试用</p>
<p>这些 player 都是由对应的 factory 创建的，对应的实现在 <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/android-5.1.1_r18/media/libmediaplayerservice/MediaPlayerFactory.cpp">MediaPlayerFactory.cpp</a> 中，其中的代码比较简单，这里就不分析了，主要是匹配不同类型对应不同的分数，然后选取分高的 player 创建。当前的主力是 STAGEFRIGHT_PLAYER 也就是 awesome player，而 NU_PLAYER  是未来的主力，从 Android M 目前的<a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/android-m-preview-2/media/libmediaplayerservice/MediaPlayerFactory.cpp">源码</a>中也可以看出代码中只剩下了 NU_PLAYER 和 STAGEFRIGHT_PLAYER，其中 NU_PLAYER 负责网络和流的播放，STAGEFRIGHT_PLAYER 负责有 DRM 和文件的播放。</p>
<p>这里我们就以目前的主力 STAGEFRIGHT_PLAYER 播放器继续往下分析。获取到播放器类型后就到了<strong>创建播放器</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sp&lt;MediaPlayerBase&gt; MediaPlayerService::Client::<span class="built_in">setDataSource_pre</span>(player_type playerType)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// create the right type of player</span></span><br><span class="line">    sp&lt;MediaPlayerBase&gt; p = <span class="built_in">createPlayer</span>(playerType);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line">sp&lt;MediaPlayerBase&gt; MediaPlayerService::Client::<span class="built_in">createPlayer</span>(player_type playerType)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// mPlayer 是当前已经有的 player，如果是刚创建这个对象，</span></span><br><span class="line">    <span class="comment">// 那么 player 是 null 需要创建新的 player</span></span><br><span class="line">    <span class="comment">// 如果创建过了了则对比下需要用到的 player 类型，避免重复创建</span></span><br><span class="line">    sp&lt;MediaPlayerBase&gt; p = mPlayer;</span><br><span class="line">    <span class="keyword">if</span> ((p != <span class="literal">NULL</span>) &amp;&amp; (p-&gt;<span class="built_in">playerType</span>() != playerType)) &#123;</span><br><span class="line">        <span class="built_in">ALOGV</span>(<span class="string">&quot;delete player&quot;</span>);</span><br><span class="line">        p.<span class="built_in">clear</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        p = MediaPlayerFactory::<span class="built_in">createPlayer</span>(playerType, <span class="keyword">this</span>, notify);</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里从 MediaPlayerFactory 创建了对应的播放器，之后使用创建好的 player 设置数据源：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">StagefrightPlayer::setDataSource</span><span class="params">(<span class="type">int</span> fd, <span class="type">int64_t</span> offset, <span class="type">int64_t</span> length)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;setDataSource(%d, %lld, %lld)&quot;</span>, fd, offset, length);</span><br><span class="line">    <span class="keyword">return</span> mPlayer-&gt;<span class="built_in">setDataSource</span>(<span class="built_in">dup</span>(fd), offset, length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的 mPlayer 就是 AwesomePlayer，AwesomePlayer 在 StagefrightPlayer 类的构造函数中创建：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">StagefrightPlayer::<span class="built_in">StagefrightPlayer</span>(): <span class="built_in">mPlayer</span>(<span class="keyword">new</span> AwesomePlayer) &#123;</span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;StagefrightPlayer&quot;</span>);</span><br><span class="line">    mPlayer-&gt;<span class="built_in">setListener</span>(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从 <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/android-5.1.1_r18/media/libmediaplayerservice/StagefrightPlayer.cpp">StagefrightPlayer</a> 的源码可以看到对象中的 AwesomePlayer 来完成。代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">AwesomePlayer::setDataSource</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="type">int</span> fd, <span class="type">int64_t</span> offset, <span class="type">int64_t</span> length)</span> </span>&#123;</span><br><span class="line">    <span class="function">Mutex::Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">	<span class="comment">// 重置播放器状态</span></span><br><span class="line">    <span class="built_in">reset_l</span>();</span><br><span class="line">	<span class="comment">// 封装成 DataSource</span></span><br><span class="line">    sp&lt;DataSource&gt; dataSource = <span class="keyword">new</span> <span class="built_in">FileSource</span>(fd, offset, length);</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">setDataSource_l</span>(dataSource);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">AwesomePlayer::setDataSource_l</span><span class="params">(<span class="type">const</span> sp&lt;DataSource&gt; &amp;dataSource)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通过 datasource 创建分离器</span></span><br><span class="line">    sp&lt;MediaExtractor&gt; extractor = MediaExtractor::<span class="built_in">Create</span>(dataSource);</span><br><span class="line">    <span class="keyword">if</span> (extractor == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (extractor-&gt;<span class="built_in">getDrmFlag</span>()) &#123;</span><br><span class="line">        <span class="built_in">checkDrmStatus</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 为分离器设置数据源</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">setDataSource_l</span>(extractor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个分离器其实和 ffpmeg 中的 demuxer 一样，作用是将数据中的音频部分和视频部分分开，然后获取到对应的类型，调用对应的解码器进行解码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">AwesomePlayer::setDataSource_l</span><span class="params">(<span class="type">const</span> sp&lt;MediaExtractor&gt; &amp;extractor)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Attempt to approximate overall stream bitrate by summing all</span></span><br><span class="line">    <span class="comment">// tracks&#x27; individual bitrates, if not all of them advertise bitrate,</span></span><br><span class="line">    <span class="comment">// we have to fail.</span></span><br><span class="line">    <span class="type">int64_t</span> totalBitRate = <span class="number">0</span>;</span><br><span class="line">    mExtractor = extractor;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; extractor-&gt;<span class="built_in">countTracks</span>(); ++i) &#123;</span><br><span class="line">        sp&lt;MetaData&gt; meta = extractor-&gt;<span class="built_in">getTrackMetaData</span>(i);</span><br><span class="line">        <span class="type">int32_t</span> bitrate;</span><br><span class="line">        <span class="keyword">if</span> (!meta-&gt;<span class="built_in">findInt32</span>(kKeyBitRate, &amp;bitrate)) &#123;</span><br><span class="line">            <span class="type">const</span> <span class="type">char</span> *mime;</span><br><span class="line">            <span class="built_in">CHECK</span>(meta-&gt;<span class="built_in">findCString</span>(kKeyMIMEType, &amp;mime));</span><br><span class="line">            <span class="built_in">ALOGV</span>(<span class="string">&quot;track of type &#x27;%s&#x27; does not publish bitrate&quot;</span>, mime);</span><br><span class="line">            totalBitRate = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 总的码率</span></span><br><span class="line">        totalBitRate += bitrate;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// metadata 就是数据中的元信息</span></span><br><span class="line">    sp&lt;MetaData&gt; fileMeta = mExtractor-&gt;<span class="built_in">getMetaData</span>();</span><br><span class="line">    <span class="keyword">if</span> (fileMeta != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="type">int64_t</span> duration;</span><br><span class="line">        <span class="keyword">if</span> (fileMeta-&gt;<span class="built_in">findInt64</span>(kKeyDuration, &amp;duration)) &#123;</span><br><span class="line">            <span class="comment">// 长度</span></span><br><span class="line">            mDurationUs = duration;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mBitrate = totalBitRate;</span><br><span class="line">    <span class="type">bool</span> haveAudio = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> haveVideo = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; extractor-&gt;<span class="built_in">countTracks</span>(); ++i) &#123;</span><br><span class="line">        sp&lt;MetaData&gt; meta = extractor-&gt;<span class="built_in">getTrackMetaData</span>(i);</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *_mime;</span><br><span class="line">        <span class="built_in">CHECK</span>(meta-&gt;<span class="built_in">findCString</span>(kKeyMIMEType, &amp;_mime));</span><br><span class="line">        String8 mime = <span class="built_in">String8</span>(_mime);</span><br><span class="line">        <span class="comment">// 视频</span></span><br><span class="line">        <span class="keyword">if</span> (!haveVideo &amp;&amp; !<span class="built_in">strncasecmp</span>(mime.<span class="built_in">string</span>(), <span class="string">&quot;video/&quot;</span>, <span class="number">6</span>)) &#123;</span><br><span class="line">            <span class="built_in">setVideoSource</span>(extractor-&gt;<span class="built_in">getTrack</span>(i));</span><br><span class="line">            haveVideo = <span class="literal">true</span>;</span><br><span class="line">			...</span><br><span class="line">        <span class="comment">// 音频</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!haveAudio &amp;&amp; !<span class="built_in">strncasecmp</span>(mime.<span class="built_in">string</span>(), <span class="string">&quot;audio/&quot;</span>, <span class="number">6</span>)) &#123;</span><br><span class="line">            <span class="built_in">setAudioSource</span>(extractor-&gt;<span class="built_in">getTrack</span>(i));</span><br><span class="line">            haveAudio = <span class="literal">true</span>;</span><br><span class="line">			...</span><br><span class="line">            <span class="comment">// ogg</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">strcasecmp</span>(mime.<span class="built_in">string</span>(), MEDIA_MIMETYPE_AUDIO_VORBIS)) &#123;</span><br><span class="line">                <span class="comment">// Only do this for vorbis audio, none of the other audio</span></span><br><span class="line">                <span class="comment">// formats even support this ringtone specific hack and</span></span><br><span class="line">                <span class="comment">// retrieving the metadata on some extractors may turn out</span></span><br><span class="line">                <span class="comment">// to be very expensive.</span></span><br><span class="line">                sp&lt;MetaData&gt; fileMeta = extractor-&gt;<span class="built_in">getMetaData</span>();</span><br><span class="line">                <span class="type">int32_t</span> loop;</span><br><span class="line">                <span class="keyword">if</span> (fileMeta != <span class="literal">NULL</span></span><br><span class="line">                        &amp;&amp; fileMeta-&gt;<span class="built_in">findInt32</span>(kKeyAutoLoop, &amp;loop) &amp;&amp; loop != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">modifyFlags</span>(AUTO_LOOPING, SET);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">strcasecmp</span>(mime.<span class="built_in">string</span>(), MEDIA_MIMETYPE_TEXT_3GPP)) &#123;</span><br><span class="line">            <span class="built_in">addTextSource_l</span>(i, extractor-&gt;<span class="built_in">getTrack</span>(i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里通过分离器来确定数据源中是音频还是视频，然后对 player 的 videotrack 和 audiotrack 进行相对应的设置。</p>
<p>到此为止 setDataSource 的流程就算是走完了，如果继续往下分析的话就到了视频的编解码的知识了。下面先用几张图来梳理一下这个过程（画的不是很规范）。</p>
<p><strong>流程图：</strong></p>
<p><img src="http://7xisp0.com1.z0.glb.clouddn.com/mediaplayer_set_data_flow.png" alt="setDataSource流程图"></p>
<p><strong>类图：</strong></p>
<p><img src="http://7xisp0.com1.z0.glb.clouddn.com/mediaplayer_class_diagram.png" alt="mediaplayer 类图"></p>
<p>类图中的 Client 是 MediaPlayerService 的内部类。MediaPlayerService 通过 IPC 和 MediaPlayerService 通信获得 Client，Client 中包含了 StagefrightPlayer，而 StagefrightPlayer 最终通过调用 AwesomePlayer 对应的方法。</p>
<h3 id="3-3-Prepare"><a href="#3-3-Prepare" class="headerlink" title="3.3 Prepare"></a>3.3 Prepare</h3><p>通过之前的经验我们可以很快的知道 prepare 应该对应的是 AwesomePlayer 中的 prepare：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">AwesomePlayer::prepare</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">prepare_l</span>();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">AwesomePlayer::prepare_l</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="type">status_t</span> err = <span class="built_in">prepareAsync_l</span>();</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> mPrepareResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">AwesomePlayer::prepareAsync_l</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mFlags &amp; PREPARING) &#123;</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN_ERROR;  <span class="comment">// async prepare already pending</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!mQueueStarted) &#123;</span><br><span class="line">        mQueue.<span class="built_in">start</span>();</span><br><span class="line">        mQueueStarted = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">modifyFlags</span>(PREPARING, SET);</span><br><span class="line">    mAsyncPrepareEvent = <span class="keyword">new</span> <span class="built_in">AwesomeEvent</span>(</span><br><span class="line">            <span class="keyword">this</span>, &amp;AwesomePlayer::onPrepareAsyncEvent);</span><br><span class="line">    mQueue.<span class="built_in">postEvent</span>(mAsyncPrepareEvent);</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mQueue 是 <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/TimedEventQueue.cpp">TimedEventQueue</a>，TimedEventQueue 和 Handler 很相似，使用 pthread 和 队列来管理消息。在这里通过异步方式回调 onPrepareAsyncEvent 方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">AwesomePlayer::onPrepareAsyncEvent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function">Mutex::Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">    <span class="built_in">beginPrepareAsync_l</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AwesomePlayer::beginPrepareAsync_l</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 取消 prepare</span></span><br><span class="line">    <span class="keyword">if</span> (mFlags &amp; PREPARE_CANCELLED) &#123;</span><br><span class="line">        <span class="built_in">ALOGI</span>(<span class="string">&quot;prepare was cancelled before doing anything&quot;</span>);</span><br><span class="line">        <span class="built_in">abortPrepare</span>(UNKNOWN_ERROR);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 网络媒体</span></span><br><span class="line">    <span class="keyword">if</span> (mUri.<span class="built_in">size</span>() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">status_t</span> err = <span class="built_in">finishSetDataSource_l</span>();</span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            <span class="built_in">abortPrepare</span>(err);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 是否包含视频</span></span><br><span class="line">    <span class="keyword">if</span> (mVideoTrack != <span class="literal">NULL</span> &amp;&amp; mVideoSource == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    	<span class="comment">// 初始化视频解码器</span></span><br><span class="line">        <span class="type">status_t</span> err = <span class="built_in">initVideoDecoder</span>();</span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            <span class="built_in">abortPrepare</span>(err);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 是否包含音频</span></span><br><span class="line">    <span class="keyword">if</span> (mAudioTrack != <span class="literal">NULL</span> &amp;&amp; mAudioSource == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    	<span class="comment">// 初始化音频解码器</span></span><br><span class="line">        <span class="type">status_t</span> err = <span class="built_in">initAudioDecoder</span>();</span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            <span class="built_in">abortPrepare</span>(err);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">modifyFlags</span>(PREPARING_CONNECTED, SET);</span><br><span class="line">	<span class="comment">// 不同的播放源类型</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isStreamingHTTP</span>()) &#123;</span><br><span class="line">    	<span class="comment">// 网络流媒体</span></span><br><span class="line">        <span class="built_in">postBufferingEvent_l</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="comment">// 本地媒体</span></span><br><span class="line">        <span class="built_in">finishAsyncPrepare_l</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">AwesomePlayer::finishAsyncPrepare_l</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mIsAsyncPrepare) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mVideoSource == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">notifyListener_l</span>(MEDIA_SET_VIDEO_SIZE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">notifyVideoSize_l</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">notifyListener_l</span>(MEDIA_PREPARED);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置 player 的状态</span></span><br><span class="line">    mPrepareResult = OK;</span><br><span class="line">    <span class="built_in">modifyFlags</span>((PREPARING|PREPARE_CANCELLED|PREPARING_CONNECTED), CLEAR);</span><br><span class="line">    <span class="built_in">modifyFlags</span>(PREPARED, SET);</span><br><span class="line">    mAsyncPrepareEvent = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">// 同步线程之间的状态</span></span><br><span class="line">    mPreparedCondition.<span class="built_in">broadcast</span>();</span><br><span class="line">	<span class="comment">// mAudioTearDown 默认为 false，当暂停的时候通过回调方法将其改为 true</span></span><br><span class="line">    <span class="keyword">if</span> (mAudioTearDown) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mPrepareResult == OK) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mExtractorFlags &amp; MediaExtractor::CAN_SEEK) &#123;</span><br><span class="line">                <span class="built_in">seekTo_l</span>(mAudioTearDownPosition);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (mAudioTearDownWasPlaying) &#123;</span><br><span class="line">                <span class="built_in">modifyFlags</span>(CACHE_UNDERRUN, CLEAR);</span><br><span class="line">                <span class="built_in">play_l</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mAudioTearDown = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过一番设置后，prepare 的过程也算是完成了。这一部分主要是对 player 的状态进行设置，通过消息机制让让调用端也知道这边的 player 状态。</p>
<h3 id="3-4-start"><a href="#3-4-start" class="headerlink" title="3.4 start"></a>3.4 start</h3><p>Java 代码这边的 start 方法对应的是 <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/libmediaplayerservice/StagefrightPlayer.cpp">StagefrightPlayer</a> 中的 start，其中又调用了 player 的 play 方法</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">StagefrightPlayer::start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;start&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> mPlayer-&gt;<span class="built_in">play</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应的是 AwesomePlayer 中的 play 方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">AwesomePlayer::play</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">ATRACE_CALL</span>();</span><br><span class="line">    <span class="function">Mutex::Autolock <span class="title">autoLock</span><span class="params">(mLock)</span></span>;</span><br><span class="line">    <span class="built_in">modifyFlags</span>(CACHE_UNDERRUN, CLEAR);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">play_l</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">AwesomePlayer::play_l</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">modifyFlags</span>(SEEK_PREVIEW, CLEAR);</span><br><span class="line">	<span class="comment">// 如果正在播放，则什么也不做</span></span><br><span class="line">    <span class="keyword">if</span> (mFlags &amp; PLAYING) &#123;</span><br><span class="line">        <span class="keyword">return</span> OK;</span><br><span class="line">    &#125;</span><br><span class="line">    mMediaRenderingStartGeneration = ++mStartGeneration;</span><br><span class="line">    <span class="comment">// 如果没有之前没有调用 prepare，这里会帮你调用一次，顺便我还做了个实验，create 之后 直接 start 是可以播放的，并没有报错什么的。</span></span><br><span class="line">    <span class="keyword">if</span> (!(mFlags &amp; PREPARED)) &#123;</span><br><span class="line">        <span class="type">status_t</span> err = <span class="built_in">prepare_l</span>();</span><br><span class="line">        <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">            <span class="keyword">return</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">modifyFlags</span>(PLAYING, SET);</span><br><span class="line">    <span class="built_in">modifyFlags</span>(FIRST_FRAME, SET);</span><br><span class="line">    <span class="keyword">if</span> (mDecryptHandle != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="type">int64_t</span> position;</span><br><span class="line">        <span class="built_in">getPosition</span>(&amp;position);</span><br><span class="line">        mDrmManagerClient-&gt;<span class="built_in">setPlaybackStatus</span>(mDecryptHandle,</span><br><span class="line">                Playback::START, position / <span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mAudioSource != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mAudioPlayer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">createAudioPlayer_l</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">CHECK</span>(!(mFlags &amp; AUDIO_RUNNING));</span><br><span class="line">        <span class="keyword">if</span> (mVideoSource == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// We don&#x27;t want to post an error notification at this point,</span></span><br><span class="line">            <span class="comment">// the error returned from MediaPlayer::start() will suffice.</span></span><br><span class="line">            <span class="type">status_t</span> err = <span class="built_in">startAudioPlayer_l</span>(<span class="literal">false</span> <span class="comment">/* sendErrorNotification */</span>);</span><br><span class="line">            <span class="comment">// 是否可以硬解音频</span></span><br><span class="line">            <span class="keyword">if</span> ((err != OK) &amp;&amp; mOffloadAudio) &#123;</span><br><span class="line">                <span class="built_in">ALOGI</span>(<span class="string">&quot;play_l() cannot create offload output, fallback to sw decode&quot;</span>);</span><br><span class="line">                <span class="type">int64_t</span> curTimeUs;</span><br><span class="line">                <span class="built_in">getPosition</span>(&amp;curTimeUs);</span><br><span class="line">                <span class="keyword">delete</span> mAudioPlayer;</span><br><span class="line">                mAudioPlayer = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="comment">// if the player was started it will take care of stopping the source when destroyed</span></span><br><span class="line">                <span class="keyword">if</span> (!(mFlags &amp; AUDIOPLAYER_STARTED)) &#123;</span><br><span class="line">                    mAudioSource-&gt;<span class="built_in">stop</span>();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">modifyFlags</span>((AUDIO_RUNNING | AUDIOPLAYER_STARTED), CLEAR);</span><br><span class="line">                mOffloadAudio = <span class="literal">false</span>;</span><br><span class="line">                mAudioSource = mOmxSource;</span><br><span class="line">                <span class="keyword">if</span> (mAudioSource != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    err = mAudioSource-&gt;<span class="built_in">start</span>();</span><br><span class="line">                    <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                        mAudioSource.<span class="built_in">clear</span>();</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mSeekNotificationSent = <span class="literal">true</span>;</span><br><span class="line">                        <span class="keyword">if</span> (mExtractorFlags &amp; MediaExtractor::CAN_SEEK) &#123;</span><br><span class="line">                            <span class="built_in">seekTo_l</span>(curTimeUs);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="built_in">createAudioPlayer_l</span>();</span><br><span class="line">                        <span class="comment">// 播放音频</span></span><br><span class="line">                        err = <span class="built_in">startAudioPlayer_l</span>(<span class="literal">false</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (err != OK) &#123;</span><br><span class="line">                <span class="keyword">delete</span> mAudioPlayer;</span><br><span class="line">                mAudioPlayer = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="built_in">modifyFlags</span>((PLAYING | FIRST_FRAME), CLEAR);</span><br><span class="line">                <span class="keyword">if</span> (mDecryptHandle != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    mDrmManagerClient-&gt;<span class="built_in">setPlaybackStatus</span>(mDecryptHandle, Playback::STOP, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// timesource 用于视音频同步，通常来说是根据 audio 中的 timesource 为基准，</span></span><br><span class="line">    <span class="comment">// 这里判断下是否有音频时间和音频播放器，如果没有，则采用系统的时间</span></span><br><span class="line">    <span class="keyword">if</span> (mTimeSource == <span class="literal">NULL</span> &amp;&amp; mAudioPlayer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mTimeSource = &amp;mSystemTimeSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 播放视频</span></span><br><span class="line">    <span class="keyword">if</span> (mVideoSource != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// Kick off video playback</span></span><br><span class="line">        <span class="built_in">postVideoEvent_l</span>();</span><br><span class="line">        <span class="keyword">if</span> (mAudioSource != <span class="literal">NULL</span> &amp;&amp; mVideoSource != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">postVideoLagEvent_l</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 流的结尾</span></span><br><span class="line">    <span class="keyword">if</span> (mFlags &amp; AT_EOS) &#123;</span><br><span class="line">        <span class="comment">// Legacy behaviour, if a stream finishes playing and then</span></span><br><span class="line">        <span class="comment">// is started again, we play from the start...</span></span><br><span class="line">        <span class="built_in">seekTo_l</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">uint32_t</span> params = IMediaPlayerService::kBatteryDataCodecStarted</span><br><span class="line">        | IMediaPlayerService::kBatteryDataTrackDecoder;</span><br><span class="line">    <span class="keyword">if</span> ((mAudioSource != <span class="literal">NULL</span>) &amp;&amp; (mAudioSource != mAudioTrack)) &#123;</span><br><span class="line">        params |= IMediaPlayerService::kBatteryDataTrackAudio;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mVideoSource != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        params |= IMediaPlayerService::kBatteryDataTrackVideo;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">addBatteryData</span>(params);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isStreamingHTTP</span>()) &#123;</span><br><span class="line">        <span class="built_in">postBufferingEvent_l</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>视频的播放是通过不断的 postVideoEvent_l 来实现画面的播放，postVideoEvent_l 会向队列中 post 一个 videoEvent，这个 event 最终又会触发 AwesomePlayer::onVideoEvent 的方法， onVideoEvent 方法中又会调用 postVideoEvent_l，形成循环，最终实现视频的播放。startAudioPlayer_l 最终会调用到 <a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/frameworks/av/+/master/media/libstagefright/AudioPlayer.cpp">AudioPlayer</a> 播放音频。</p>
<p>播放的过程到这里就结束了，接下来暂停和结束的部分就相对简单了。</p>
<h3 id="3-5-pause"><a href="#3-5-pause" class="headerlink" title="3.5 pause"></a>3.5 pause</h3><p>pause 对应到 AwesomePlayer 中是 pause_l 这个方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">AwesomePlayer::pause_l</span><span class="params">(<span class="type">bool</span> at_eos)</span> </span>&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="comment">// 通知客户端播放器暂停</span></span><br><span class="line">    <span class="built_in">notifyListener_l</span>(MEDIA_PAUSED);</span><br><span class="line">    mMediaRenderingStartGeneration = ++mStartGeneration;</span><br><span class="line">	<span class="comment">// cancel 播放视频的队列</span></span><br><span class="line">    <span class="built_in">cancelPlayerEvents</span>(<span class="literal">true</span> <span class="comment">/* keepNotifications */</span>);</span><br><span class="line">    <span class="keyword">if</span> (mAudioPlayer != <span class="literal">NULL</span> &amp;&amp; (mFlags &amp; AUDIO_RUNNING)) &#123;</span><br><span class="line">        <span class="comment">// If we played the audio stream to completion we</span></span><br><span class="line">        <span class="comment">// want to make sure that all samples remaining in the audio</span></span><br><span class="line">        <span class="comment">// track&#x27;s queue are played out.</span></span><br><span class="line">        mAudioPlayer-&gt;<span class="built_in">pause</span>(at_eos <span class="comment">/* playPendingSamples */</span>);</span><br><span class="line">        <span class="comment">// send us a reminder to tear down the AudioPlayer if paused for too long.</span></span><br><span class="line">        <span class="keyword">if</span> (mOffloadAudio) &#123;</span><br><span class="line">            <span class="built_in">postAudioTearDownEvent</span>(kOffloadPauseMaxUs);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">modifyFlags</span>(AUDIO_RUNNING, CLEAR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (mFlags &amp; TEXTPLAYER_INITIALIZED) &#123;</span><br><span class="line">        mTextDriver-&gt;<span class="built_in">pause</span>();</span><br><span class="line">        <span class="built_in">modifyFlags</span>(TEXT_RUNNING, CLEAR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">modifyFlags</span>(PLAYING, CLEAR);</span><br><span class="line">    <span class="keyword">if</span> (mDecryptHandle != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        mDrmManagerClient-&gt;<span class="built_in">setPlaybackStatus</span>(mDecryptHandle,</span><br><span class="line">                Playback::PAUSE, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">return</span> OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-6-stop"><a href="#3-6-stop" class="headerlink" title="3.6 stop"></a>3.6 stop</h3><p>然而 stop 和 pause 并没什么区别，代码中的注释也是挺有意思</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">StagefrightPlayer::stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;stop&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pause</span>();  <span class="comment">// what&#x27;s the difference?</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">status_t</span> <span class="title">StagefrightPlayer::pause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mPlayer-&gt;<span class="built_in">pause</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-7-release"><a href="#3-7-release" class="headerlink" title="3.7 release"></a>3.7 release</h3><p>MeidaPlayer 对应 jni 中的 android_media_MediaPlayer_release 方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span></span></span><br><span class="line"><span class="function"><span class="title">android_media_MediaPlayer_release</span><span class="params">(JNIEnv *env, jobject thiz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;release&quot;</span>);</span><br><span class="line">    <span class="built_in">decVideoSurfaceRef</span>(env, thiz);</span><br><span class="line">    sp&lt;MediaPlayer&gt; mp = <span class="built_in">setMediaPlayer</span>(env, thiz, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (mp != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// this prevents native callbacks after the object is released</span></span><br><span class="line">        mp-&gt;<span class="built_in">setListener</span>(<span class="number">0</span>);</span><br><span class="line">        mp-&gt;<span class="built_in">disconnect</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>setListener 注释中说的很明白了，就是把 listener 置空。diconnect 这里是断开了了和 mediaserver 的连接。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">MediaPlayer::disconnect</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">ALOGV</span>(<span class="string">&quot;disconnect&quot;</span>);</span><br><span class="line">    sp&lt;IMediaPlayer&gt; p;</span><br><span class="line">    &#123;</span><br><span class="line">        Mutex::Autolock _l(mLock);</span><br><span class="line">        p = mPlayer;</span><br><span class="line">        mPlayer.<span class="built_in">clear</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="number">0</span>) &#123;</span><br><span class="line">        p-&gt;<span class="built_in">disconnect</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-总结"><a href="#4-总结" class="headerlink" title="4.总结"></a>4.总结</h2><p>MediaPlayer 整体上的流程就是这些，其中相对复杂的地方集中在编解码和不同 player 的使用上。编解码相关的主要是 OMX 的硬解和软解，player 主要是不同的 Android 版本对不同的 player 优先使用不同。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2015/09/13/2015/2015-09-13-Toolbar%E7%9A%84Theme/" rel="prev" title="Toolbar的Theme">
                  <i class="fa fa-chevron-left"></i> Toolbar的Theme
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2015/10/09/2015/2015-10-09-C++%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E4%B8%83/" rel="next" title="C++学习笔记之七">
                  C++学习笔记之七 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bill Lv</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  

  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.9.1/firebase-app-compat.js" integrity="sha256-BZqADJTynzztcubgFmplXDkhMk7o/6KO4tHzL8X+biE=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.9.1/firebase-firestore-compat.js" integrity="sha256-8Y5+rcygX0v5tCQhOjr4rob7oykEcp6IhhutNKKGzfk=" crossorigin="anonymous"></script>
  <script class="next-config" data-name="firestore" type="application/json">{"enable":true,"collection":"articles","apiKey":"AIzaSyAUEkp4sjguJNc-EW2Hu8T3WQ57z931SbA","projectId":"blog-7bba0"}</script>
  <script src="/js/third-party/statistics/firestore.js"></script>




</body>
</html>
